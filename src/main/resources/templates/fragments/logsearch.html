<div th:fragment="content"
	xmlns:th="http://www.thymeleaf.org">
		
	<div class="row">
		<div class="col-md-12">
			<div class="box box-solid box-primary">
				<div class="box-header with-border ">
					<h6 class="box-title">Log Trails</h6>

					<div class="box-tools pull-right">
						<button type="button" class="btn btn-box-tool"
							data-widget="collapse">
							<i class="fa fa-minus"></i>
						</button>
					</div>
				</div>
				<!-- box header -->

				<div class="box-body">
					<div id="mainForm" style="display: none;">

						<div class="box ">

							<table id="batchExecPtDetailsTable"
								class="table table-bordered table-striped table-hover table-condensed dt-responsive nowrap">
								<thead>
									<tr>
										<th>Timestamp</th>
										<th>Log Level</th>
										<th>Exec Thread</th>
										<th>Logged Text</th>
									</tr>
								</thead>
								<tbody>

								</tbody>

							</table>
						</div>

					</div>


				</div>
				<!-- ./box-body -->

			</div>
			<!-- /.box -->
		</div>
		<!-- /.col -->
	</div>
	<!-- /.row -->
	
	<div class="row">
		
		<div class="col-md-12">
			<div class="box box-solid box-primary">
				<div class="box-header">
					<h6 class="box-title">Hourly Error Trend</h6>
					<div class="box-tools pull-right">
						<button id="btnTHourly" type="button" class="btn btn-box-tool">
							<i class="fa fa-line-chart"></i>
						</button>
						<button type="button" class="btn btn-box-tool"
							data-widget="collapse">
							<i class="fa fa-minus"></i>
						</button>
					</div>
				</div>
				<div class="box-body">
					<div id="btnTHLoading" style="display: none;" class="overlay">
						<i class="fa fa-refresh fa-spin"></i>
					</div>
					<div id="divTH" class="chart" style="overflow: scroll;"
						align="center">
						<canvas id="thChart" width="800" height="200"></canvas>
					</div>
				</div>
			</div>
		</div>
		<!-- /.col -->
	</div>
	<!-- /.row -->

	<div class="row">
		<div class="col-md-6">
			<div class="box box-solid box-primary">
				<div class="box-header">
					<h6 class="box-title">Daily Error Trend</h6>
					<div class="box-tools pull-right">
						<button id="btnTDaily" type="button" class="btn btn-box-tool">
							<i class="fa fa-line-chart"></i>
						</button>
						<button type="button" class="btn btn-box-tool"
							data-widget="collapse">
							<i class="fa fa-minus"></i>
						</button>
					</div>

				</div>
				<div class="box-body">
					<div id="btnTDLoading" style="display: none;" class="overlay">
						<i class="fa fa-refresh fa-spin"></i>
					</div>
					<div id="divTD" class="chart" style="overflow: scroll;"
						align="center">
						<canvas id="tdChart" width="800" height="200"></canvas>
					</div>
				</div>
			</div>
		</div>
		<!-- /.col -->
		<div class="col-md-6">
			<div class="box box-solid box-primary">
				<div class="box-header">
					<h6 class="box-title">Execution Timing Trend</h6>
					<div class="box-tools pull-right">
						<button id="btnExecT" type="button" class="btn btn-box-tool" data-toggle="modal" data-target="#execTModal">
							<i class="fa fa-line-chart"></i>
						</button>
						<button type="button" class="btn btn-box-tool"
							data-widget="collapse">
							<i class="fa fa-minus"></i>
						</button>
					</div>
				</div>
				<div class="box-body">
					<div id="btnExecTLoading" style="display: none;" class="overlay">
						<i class="fa fa-refresh fa-spin"></i>
					</div>
					<div id="divExecT" class="chart" style="overflow: scroll;"
						align="center">
						<canvas id="exChart" width="800" height="200"></canvas>
					</div>
				</div>
			</div>
		</div>

	</div>

	<!-- /.row -->

	<!-- Wait Modal Start here-->
	<div class="modal fade bs-example-modal-sm" id="myPleaseWait"
		tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static">
		<div class="modal-dialog modal-sm">
			<div class="modal-content">
				<div class="modal-header">
					<h4 class="modal-title">
						<span> </span>Processing..
					</h4>
				</div>
				<div class="modal-body">
					<div class="progress">
						<div
							class="progress-bar progress-bar-info
                    progress-bar-striped active"
							style="width: 100%"></div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<!-- Wait Modal ends Here -->

	<!-- Execution timing term modal -->
	<div class="modal fade modal-info" id="execTModal" >
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" id="btnExModalClose" class="close" data-dismiss="modal">
						<span aria-hidden="true">&times;</span> <span class="sr-only">Close</span>
					</button>
					<h4 class="modal-title">Execution Timing Trend - additional parameters required</h4>
				</div>
				<div id="nodataDiv" class="alert alert-warning" align="center"
					style="display: none;">
					<h5>
						<i class="fa fa-warning"></i>&nbsp;&nbsp;<span>Execution start/stop marks are required!</span>
					</h5>
				</div>
				<div class="modal-body">
					<form class="form-horizontal">
						<div class="box-body">
							<div class="form-group">
								<label class="col-sm-4 control-label">Start Mark</label>

								<div class="col-sm-8">
									<input type="text" class="form-control" id="inputExecBegin"
										placeholder="Execution begin phrase to search.."/>
								</div>
							</div>
							<div class="form-group">
								<label class="col-sm-4 control-label">Stop Mark</label>

								<div class="col-sm-8">
									<input type="text" class="form-control" id="inputExecEnd"
										placeholder="Execution end phrase to search.."/>
								</div>
							</div>
							
						</div>
						<!-- /.box-body -->
						
					</form>
				</div>
				<div class="modal-footer">
					<button type="button" id="btnExecTSubmit" class="btn btn-primary pull-right">Submit</button>
				</div>
			</div>
			<!-- /.modal-content -->
		</div>
		<!-- /.modal-dialog -->
	</div>
	<!-- /.modal -->

	<script th:inline="javascript">
		
		//Note: the CDATA is for Thymeleaf inline processing.
		//setting a javascript var using a server side attribute
		
		/*<![CDATA[*/
				
		var _url = [[@{/logsearch}]];
		var _urlChart = [[@{/logtrend}]];
		var _urlExec = [[@{/exectrend}]];
		
		var refresh;
		var table;
		var tdCanvas,thCanvas, exCanvas;
		var tdCtx, thCtx, exCtx;
				
		$(document).ready(function() {
			refresh = $('#autoRefresh').is(':checked');
			thCanvas = $('#thChart').get(0);
			tdCanvas = $('#tdChart').get(0);
			exCanvas = $('#exChart').get(0);
			
			$('#btnExModalClose').click(function(){
				$('#nodataDiv').hide();
			});
			
			//execution timing modal submit
			$('#btnExecTSubmit').click(function(){
				var term_1, term_2, appId, dtRange;
				term_1 = $('#inputExecBegin').val();
				term_2 = $('#inputExecEnd').val();
				appId = $('#appId').val();
				dtRange = $('#reportrange').val();
				
				if(!appId){
					$('#execTModal').modal('hide');
					showAlertModal('Application ID is required');
					return;
				}
				if(!dtRange){
					$('#execTModal').modal('hide');
					showAlertModal('Date Range is required');
					return;
				}
				if(!term_1 || !term_2){
					$('#nodataDiv').show();
					return;
				}
				
				$.ajax({
					url : _urlExec,
					method : 'GET',
					data: {p_term_1: term_1, p_term_2: term_2, p_appid: appId, p_dtrange: dtRange, p_level: $('#level').val()},
					dataType: "json",
					success : function(data){
						$('#btnExecTLoading').hide();
								
						  if(data.error){
							  showAlertModal(data.error);
							  return;
						  }
						  if(exCtx){
							  exCtx.clearRect(0, 0, exCanvas.width, exCanvas.height);
						  }
						  exCtx = exCanvas.getContext("2d");
				          var myNewChart = new Chart(exCtx).Bar(data, {
				        	    bezierCurve: false,
				        	    responsive: true,
				        	    maintainAspectRatio: false
				          });
				          
	          
					},//end success
					error : function(err){
						$('#btnExecTLoading').hide();
						showAlertModal('Internal server error');
						console.log('Error => '+err);
					},
					beforeSend : function(){
						$('#execTModal').modal('hide');
						if(exCtx){
							  exCtx.clearRect(0, 0, exCanvas.width, exCanvas.height);
						  }
						$('#btnExecTLoading').show();
					}
				});
			});
			
			$('#btnTHourly').click(function(){
				var term, appId, dtRange;
				term = $('#term').val();
				appId = $('#appId').val();
				dtRange = $('#reportrange').val();
				
				if(!appId){
					showAlertModal('Application ID is required');
					return;
				}
				if(!dtRange){
					showAlertModal('Date Range is required');
					return;
				}
				
				$.ajax({
					url : _urlChart,
					method : 'GET',
					data: {p_term: term, p_appid: appId, p_dtrange: dtRange, p_level: 'ERROR', p_freq: 'HOURLY'},
					dataType: "json",
					success : function(data){
						$('#btnTHLoading').hide();
						if(data.error){
							  showAlertModal(data.error);
							  return;
						  }		
						  if(thCtx){
							  thCtx.clearRect(0, 0, thCanvas.width, thCanvas.height);
						  }
						  thCtx = thCanvas.getContext("2d");
				          var myNewChart = new Chart(thCtx).Line(data, {
				        	    bezierCurve: false,
				        	    responsive: true,
				        	    maintainAspectRatio: false
				          });
				          
	          
					},//end success
					error : function(err){
						$('#btnTHLoading').hide();
						console.log('Error => '+err);
					},
					beforeSend : function(){
						if(thCtx){
							  thCtx.clearRect(0, 0, thCanvas.width, thCanvas.height);
						  }
						$('#btnTHLoading').show();
					}
				});
			});
			$('#btnTDaily').click(function(){
				var term, appId, dtRange;
				term = $('#term').val();
				appId = $('#appId').val();
				dtRange = $('#reportrange').val();
				
				if(!appId){
					showAlertModal('Application ID is required');
					return;
				}
				if(!dtRange){
					showAlertModal('Date Range is required');
					return;
				}
				
				$.ajax({
					url : _urlChart,
					method : 'GET',
					data: {p_term: term, p_appid: appId, p_dtrange: dtRange, p_level: 'ERROR', p_freq: 'DAILY'},
					dataType: "json",
					success : function(data){
						$('#btnTDLoading').hide();
						if(data.error){
							  showAlertModal(data.error);
							  return;
						  }					          
						if(tdCtx){
							  tdCtx.clearRect(0, 0, tdCanvas.width, tdCanvas.height);
						  }
						  tdCtx = tdCanvas.getContext("2d");
				          var myNewChart = new Chart(tdCtx).Line(data, {
				        	    bezierCurve: false,
				        	    responsive: true,
				        	    maintainAspectRatio: false
				          });
				          
	          
					},//end success
					error : function(err){
						$('#btnTDLoading').hide();
						console.log('Error => '+err);
					},
					beforeSend : function(){
						if(tdCtx){
							  tdCtx.clearRect(0, 0, tdCanvas.width, tdCanvas.height);
						  }
						$('#btnTDLoading').show();
					}
				});
				
				
			});
			
			$('#reportrange').on('cancel.daterangepicker', function(ev, picker) {
			      $(this).val('');
			 });
			
		    $('#reportrange').daterangepicker(
		        {
		          ranges: {
		            'Today': [moment(), moment().add(1, 'days')],
		            'Yesterday': [moment().subtract(1, 'days'), moment()],
		            'Last 7 Days': [moment().subtract(6, 'days'), moment()],
		            'Last 30 Days': [moment().subtract(29, 'days'), moment()],
		            'This Month': [moment().startOf('month'), moment().endOf('month')],
		            'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
		          },
		          startDate: moment().subtract(29, 'days'),
		          endDate: moment(),
		          autoUpdateInput: false,
		          locale: {
		              cancelLabel: 'Clear'
		          }
		        },
		        function (start, end) {
		          $('#reportrange').text(start.format('MMM D, YYYY') + ' - ' + end.format('MMM D, YYYY'));
		        }
		    );
			      		      		
			//handle checkbox toggle
			$('#autoRefresh').change(function() {
		        if($(this).is(":checked")) {
		        	refresh = true;
		            refreshPage();
		            timer = setInterval(refreshPage, 5000);
		            
		        }
		        else{
		        	refresh = false;
		        	if(timer)
		        		clearInterval(timer);
		        }
		          
		    });
			
			//handle refresh button click
			$('#btnRefresh').click(function(){
				refreshPage();
			});
						
			if(refresh){
				timer = setInterval(refreshPage, 5000);
			}	
			

		});
				
		function refreshPage(){
			//local variables
			var firstRowUUID, lastRowUUID;
			var term, appId, dtRange;
			var prev;
			var lastPage,currPage;
			
			//using location.reload() would take the context out of this request
			term = $('#term').val();
			appId = $('#appId').val();
			dtRange = $('#reportrange').val();
			lastPage = 0;
			currPage = 0;
			
			if(!appId){
				showAlertModal('Application ID is required');
				return;
			}
			if(!dtRange){
				showAlertModal('Date Range is required');
				return;
			}	
			
			$('#nodataDiv').hide();
			$('#mainForm').hide();
			$('#myPleaseWait').modal('show');
			
			if(table){
				table.destroy();
			}
						
			table = $('#batchExecPtDetailsTable')
			.DataTable({	
				"scrollX": true,
				"processing" : true,
			    "serverSide" : true,
			    //"bLenthChange" : false,
			    "pageLength" : 10,
			    "orderFixed": [ 0, 'desc' ],
			    "ajax": {
			        "url": 'logsearch',
			        "dataSrc": 'logs',
			        "data": function ( d ) {
			        	return $.extend( {}, d, {
			        		"p_term" : term,
				            "p_appid" : appId,
				            "p_level" : $('#level').val(),
				            "p_dtrange" : dtRange,
				            "p_refresh" : refresh,
				            "p_frowid" : firstRowUUID,
				            "p_lrowid" : lastRowUUID,
				            "p_prev" : (lastPage > currPage)
			              } );
			            
			        }
			      },
			    "autoWidth" : false,
			    "searching": false,
			    "initComplete": function (oSettings, json) {
			        $("#myPleaseWait").modal("hide");
			        $('#mainForm').show();
			        			      	
			    },
			    "columnDefs": [
			                   { className: "wordWrap", "targets": [ 2 ] }
			                 ],
			    "columns" : [
						       {
						        "title" : "Timestamp",
						        "mDataProp" : "timestampText",
						        "orderable": false
						       },
						       {
							        "title" : "Log Level",
							        "mDataProp" : "level",
							        "orderable": false
							   },
							   {
							        "title" : "Exec Thread",
							        "mDataProp" : "execId",
							        "orderable": false
							   },
						       {
						        "title" : "Logged Text",
						        "mDataProp" : "logText",
						        "orderable": false
						       }],
                  "pagingType" : "simple"
            	});
			
			table.on( 'xhr', function () {
			    var json = table.ajax.json();
			    firstRowUUID = json['firstRowUUID'];
		        lastRowUUID = json['lastRowUUID'];
		        
			} );
			table.on( 'page.dt', function () {
			    var info = table.page.info();
			    //console.log('Showing page: '+JSON.stringify(info));
			    lastPage = currPage;
			    currPage = info.page;
			} );
			table.on('preXhr.dt', function ( e, settings, data ) {
				
    		} );		
			
			table.columns.adjust().draw();
		}
		
		/*]]>*/
	</script>

</div>
<!-- /.box -->
