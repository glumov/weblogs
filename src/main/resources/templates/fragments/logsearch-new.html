<div class="box box-solid box-primary" th:fragment="content"
	xmlns:th="http://www.thymeleaf.org">

	<div class="row">
		<div class="col-md-12">
			<div class="box">
				<div class="box-header with-border">
					<h3 class="box-title">Log Search View</h3>

					<div class="box-tools pull-right">
						<button type="button" class="btn btn-box-tool"
							data-widget="collapse">
							<i class="fa fa-minus"></i>
						</button>

					</div>
				</div>
				<table style="border-collapse: separate; border-spacing: 20px;">
					<tr>
						<td><label>Application ID </label>&nbsp;&nbsp;<input
							type="text" id="appId" name="appId" /></td>
						<td><label>Search Term </label>&nbsp;&nbsp;<input type="text"
							id="term" name="term" /></td>
						<td><label>Auto Refresh </label>&nbsp;&nbsp; <input
							disabled="disabled" th:checked="${p_refresh == true}"
							id="autoRefresh" type="checkbox" name="autoRefresh"></input></td>

					</tr>
					<tr>

						<td>
							<!-- Date and time range --> <label>Date Range</label>&nbsp;&nbsp;

							<input type="text" id="reportrange" />
						</td>
						<td><label>Log Level </label>&nbsp;&nbsp;<input type="text"
							id="level" name="level" /></td>
						<td>
							<button id="btnRefresh" class="btn btn-primary">
								<span class="glyphicon glyphicon-search"></span> Search
							</button>
						</td>
					</tr>
				</table>
				<div id="mainForm" style="display: none;">

					<div class="box box-solid box-primary">
						<div class="box-header">
							<h4 class="box-title">Log Trail</h4>

						</div>
						<table id="batchExecPtDetailsTable"
							class="table table-bordered table-striped table-hover table-condensed dt-responsive nowrap">
							<thead>
								<tr>
									<th>Timestamp</th>
									<th>Log Level</th>
									<th>Logged Text</th>
								</tr>
							</thead>
							<tbody>

							</tbody>

						</table>
					</div>

				</div>

			</div>
			<!-- /.box -->
		</div>
		<!-- /.col -->
	</div>
	<!-- /.row -->
    
    		
	<!-- Wait Modal Start here-->
	<div class="modal fade bs-example-modal-sm" id="myPleaseWait"
		tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static">
		<div class="modal-dialog modal-sm">
			<div class="modal-content">
				<div class="modal-header">
					<h4 class="modal-title">
						<span> </span>
					</h4>
				</div>
				<div class="modal-body">
					<div class="progress">
						<div
							class="progress-bar progress-bar-info
                    progress-bar-striped active"
							style="width: 100%"></div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<!-- Wait Modal ends Here -->
		
	<script th:inline="javascript">
		
		//Note: the CDATA is for Thymeleaf inline processing.
		//setting a javascript var using a server side attribute
		
		/*<![CDATA[*/
				
		var _url = [[@{/logsearch}]];
		var refresh;
		var table;
				
		$(document).ready(function() {
			refresh = $('#autoRefresh').is(':checked');
			
			$('#reportrange').on('cancel.daterangepicker', function(ev, picker) {
			      $(this).val('');
			 });
			
		    $('#reportrange').daterangepicker(
		        {
		          ranges: {
		            'Today': [moment(), moment().add(1, 'days')],
		            'Yesterday': [moment().subtract(1, 'days'), moment()],
		            'Last 7 Days': [moment().subtract(6, 'days'), moment()],
		            'Last 30 Days': [moment().subtract(29, 'days'), moment()],
		            'This Month': [moment().startOf('month'), moment().endOf('month')],
		            'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
		          },
		          startDate: moment().subtract(29, 'days'),
		          endDate: moment(),
		          autoUpdateInput: false,
		          locale: {
		              cancelLabel: 'Clear'
		          }
		        },
		        function (start, end) {
		          $('#reportrange').text(start.format('MMM D, YYYY') + ' - ' + end.format('MMM D, YYYY'));
		        }
		    );
			      		      		
			//handle checkbox toggle
			$('#autoRefresh').change(function() {
		        if($(this).is(":checked")) {
		        	refresh = true;
		            refreshPage();
		            timer = setInterval(refreshPage, 5000);
		            
		        }
		        else{
		        	refresh = false;
		        	if(timer)
		        		clearInterval(timer);
		        }
		          
		    });
			
			//handle refresh button click
			$('#btnRefresh').click(function(){
				refreshPage();
			});
						
			if(refresh){
				timer = setInterval(refreshPage, 5000);
			}	
			

		});
				
		function refreshPage(){
			//local variables
			var firstRowUUID, lastRowUUID;
			var term, appId, dtRange;
			var prev;
			var lastPage,currPage;
			
			//using location.reload() would take the context out of this request
			term = $('#term').val();
			appId = $('#appId').val();
			dtRange = $('#reportrange').val();
			lastPage = 0;
			currPage = 0;
			
			if(!appId){
				showAlertModal('Application ID is required');
				return;
			}
			if(!dtRange){
				showAlertModal('Date Range is required');
				return;
			}	
			
			$('#nodataDiv').hide();
			$('#mainForm').hide();
			$('#myPleaseWait').modal('show');
			
			if(table){
				table.destroy();
			}
						
			table = $('#batchExecPtDetailsTable')
			.DataTable({	
				
				"processing" : true,
			    "serverSide" : true,
			    "bLenthChange" : false,
			    "pageLength" : 10,
			    "orderFixed": [ 0, 'desc' ],
			    "ajax": {
			        "url": 'logsearch',
			        "dataSrc": 'logs',
			        "data": function ( d ) {
			        	return $.extend( {}, d, {
			        		"p_term" : term,
				            "p_appid" : appId,
				            "p_level" : $('#level').val(),
				            "p_dtrange" : dtRange,
				            "p_refresh" : refresh,
				            "p_frowid" : firstRowUUID,
				            "p_lrowid" : lastRowUUID,
				            "p_prev" : (lastPage > currPage)
			              } );
			            
			        }
			      },
			    "autoWidth" : false,
			    "searching": false,
			    "initComplete": function (oSettings, json) {
			        $("#myPleaseWait").modal("hide");
			        $('#mainForm').show();
			        			      	
			    },
			    "columnDefs": [
			                   { className: "wordWrap", "targets": [ 2 ] }
			                 ],
			    "columns" : [
						       {
						        "title" : "Timestamp",
						        "mDataProp" : "timestampText",
						        "orderable": false
						       },
						       {
							        "title" : "Log Level",
							        "mDataProp" : "level",
							        "orderable": false
							   },
						       {
						        "title" : "Logged Text",
						        "mDataProp" : "logText",
						        "orderable": false
						       }],
                  "pagingType" : "simple"
            	});
			
			table.on( 'xhr', function () {
			    var json = table.ajax.json();
			    firstRowUUID = json['firstRowUUID'];
		        lastRowUUID = json['lastRowUUID'];
		        
			} );
			table.on( 'page.dt', function () {
			    var info = table.page.info();
			    //console.log('Showing page: '+JSON.stringify(info));
			    lastPage = currPage;
			    currPage = info.page;
			} );
			table.on('preXhr.dt', function ( e, settings, data ) {
				
    		} );		
			
		}
		
		/*]]>*/
	</script>

</div>
<!-- /.box -->
